<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mary Teaches English ‚Äî Progress Tracker</title>
  <style>
    :root{
      --bg1:#fff3d6;
      --bg2:#ffe8f1;
      --ink:#1c1b22;
      --muted:#5a5a6a;
      --stroke:#1c1b22;
      --pink:#ff4fa3;
      --blue:#2e7bff;
      --mint:#2fe6b8;
      --yellow:#ffd84d;
      --shadow: 0 14px 0 rgba(28,27,34,.18);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      color:var(--ink);
      font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1100px 520px at 15% -10%, rgba(46,123,255,.22), transparent 55%),
        radial-gradient(900px 520px at 95% 0%, rgba(255,79,163,.18), transparent 55%),
        radial-gradient(900px 520px at 60% 110%, rgba(47,230,184,.16), transparent 55%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }

    header{
      position: sticky;
      top:0;
      z-index:10;
      background: rgba(255,255,255,.72);
      backdrop-filter: blur(10px);
      border-bottom: 3px solid var(--stroke);
    }

    .wrap{max-width:1100px;margin:0 auto;padding:18px 16px}

    .top{display:flex;gap:12px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;gap:12px;align-items:center;min-width:260px}

    .logo{
      width:52px;height:52px;
      border-radius:16px;
      border:3px solid var(--stroke);
      background: conic-gradient(from 210deg, var(--pink), var(--yellow), var(--mint), var(--blue), var(--pink));
      box-shadow: var(--shadow);
      position:relative;
      transform: rotate(-2deg);
      flex:0 0 auto;
    }
    .logo:after{
      content:"‚ú®";
      position:absolute;
      right:-10px;
      top:-12px;
      font-size:18px;
      transform: rotate(8deg);
    }

    h1{margin:0;font-size:18px;letter-spacing:.2px;line-height:1.1}
    .sub{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.35}

    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}

    .search{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      border:3px solid var(--stroke);
      background: rgba(255,255,255,.85);
      box-shadow: var(--shadow);
      min-width: 260px;
      max-width: 420px;
      width: min(420px, 70vw);
    }
    .search span{font-weight:900}
    .search input{
      border:0;
      outline:0;
      background: transparent;
      width:100%;
      font-weight:800;
      color:var(--ink);
      font-size:13px;
    }
    .search input::placeholder{color: rgba(90,90,106,.8)}

    .pill{
      padding:9px 12px;
      border:3px solid var(--stroke);
      border-radius:999px;
      font-size:13px;
      background: rgba(255,255,255,.85);
      box-shadow: var(--shadow);
      white-space:nowrap;
      font-weight:700;
    }

    .hint{margin-top:12px}
    .note{
      display:inline-flex;gap:10px;align-items:center;
      padding:10px 12px;
      border:3px dashed rgba(28,27,34,.6);
      border-radius:16px;
      background: rgba(255,255,255,.65);
      font-size:13px;
      color:var(--muted);
      max-width: 900px;
    }

    code{
      background: rgba(255,79,163,.12);
      border:2px solid rgba(28,27,34,.35);
      padding:2px 7px;
      border-radius:10px;
      color: var(--ink);
      font-weight:800;
    }

    main{padding: 10px 0 28px}

    .leaderCard{
      border:3px solid var(--stroke);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.72));
      box-shadow: var(--shadow);
      padding:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      position:relative;
      overflow:hidden;
    }
    .leaderCard:before{
      content:"LEADER";
      position:absolute;
      left:-30px;
      top:10px;
      transform: rotate(-12deg);
      padding:6px 44px;
      font-size:11px;
      font-weight:900;
      letter-spacing:.8px;
      border:3px solid var(--stroke);
      background: var(--pink);
      color:white;
      box-shadow: 0 8px 0 rgba(28,27,34,.12);
    }
    .leaderTitle{font-weight:950;font-size:14px}
    .leaderName{font-weight:950;font-size:18px;line-height:1.2}
    .leaderMeta{color:var(--muted);font-weight:900;font-size:13px}

    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap:14px;
      padding: 6px 16px 0;
      max-width:1100px;
      margin:0 auto;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.72));
      border:3px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display:flex;
      min-height:112px;
      overflow:hidden;
      position:relative;
    }
    .card:before{
      content: "PROGRESS";
      position:absolute;
      right:-34px;
      top:10px;
      transform: rotate(18deg);
      padding:6px 40px;
      font-size:11px;
      font-weight:900;
      letter-spacing:.8px;
      border:3px solid var(--stroke);
      background: var(--yellow);
      box-shadow: 0 8px 0 rgba(28,27,34,.12);
    }

    .left{width:92px;display:flex;align-items:center;justify-content:center;padding:12px}
    .avatar{
      width:68px;height:68px;
      border-radius:16px;
      border:3px solid var(--stroke);
      background: linear-gradient(135deg, rgba(46,123,255,.18), rgba(255,79,163,.16));
      box-shadow: 0 10px 0 rgba(28,27,34,.12);
      overflow:hidden;
      display:flex;align-items:center;justify-content:center;
    }
    .avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .avatar .fallback{font-size:28px}

    .mid{flex:1;padding:14px 10px 14px 0;display:flex;flex-direction:column;justify-content:center;gap:8px;min-width:0}

    .name{
      font-weight:950;
      font-size:16px;
      line-height:1.25;
      white-space:normal;
      overflow:visible;
    }

    .meta{color:var(--muted);font-size:13px;font-weight:800;display:flex;flex-direction:column;gap:8px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border:2px solid rgba(28,27,34,.45);
      border-radius: 999px;
      background: rgba(47,230,184,.18);
      font-size:12px;
      font-weight:900;
    }

    .bar{
      height:10px;
      border-radius:999px;
      border:2px solid rgba(28,27,34,.35);
      background: rgba(255,255,255,.65);
      overflow:hidden;
      width: min(320px, 100%);
    }
    .bar > i{
      display:block;
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--mint), var(--blue), var(--pink));
    }

    .right{min-width:120px;padding:14px 14px 14px 8px;display:flex;align-items:center;justify-content:flex-end;gap:6px;flex-wrap:wrap}
    .check{font-size:20px;filter: drop-shadow(0 10px 0 rgba(28,27,34,.10))}

    .empty{
      color: rgba(90,90,106,.85);
      font-weight:900;
      font-size:13px;
      padding:6px 10px;
      border:2px solid rgba(28,27,34,.28);
      border-radius:999px;
      background: rgba(255,255,255,.65);
    }

    .footer-tip{
      max-width:1100px;
      margin: 14px auto 0;
      padding: 0 16px;
      color: rgba(90,90,106,.9);
      font-size: 13px;
      font-weight:800;
    }

    @media (max-width:520px){
      .card:before{display:none}
      .right{min-width:100px}
      .grid{grid-template-columns: 1fr}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="top">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1>Mary Teaches English ‚Äî Progress Tracker</h1>
            <div class="sub">CSV: <b>–§–ò–û</b>, <b>–∑–∞–¥–∞–Ω–∏—è</b>, <b>–∞–≤–∞—Ç–∞—Ä–∫–∞</b> ‚Ä¢ 1 ‚úÖ –∑–∞ –∫–∞–∂–¥—ã–µ 5 –∑–∞–¥–∞–Ω–∏–π</div>
          </div>
        </div>

        <div class="controls">
          <div class="search" role="search">
            <span>üîé</span>
            <input id="q" type="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –§–ò–û‚Ä¶" autocomplete="off" />
          </div>
          <div id="stats" class="pill">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
        </div>
      </div>

      <div class="hint">
        <div class="note">üí° –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä–æ–∫–∏: <code>–ò–≤–∞–Ω–æ–≤–∞ –ú–∞—Ä–∏—è,12,images/maria.jpg</code> (–∏–ª–∏ URL –≤–º–µ—Å—Ç–æ –ø—É—Ç–∏). –ï—Å–ª–∏ –∞–≤–∞—Ç–∞—Ä–∫–∏ –Ω–µ—Ç ‚Äî –ø–æ–∫–∞–∂—É üéì.</div>
      </div>
    </div>
  </header>

  <main>
    <section class="wrap" style="padding-top:14px">
      <div id="leader" aria-live="polite"></div>
    </section>

    <div id="grid" class="grid" aria-live="polite"></div>

    <div class="footer-tip">‚úÖ = <b>–∫–∞–∂–¥—ã–µ 5</b> –∑–∞–¥–∞–Ω–∏–π ‚Ä¢ –ü–æ–ª–æ—Å–∞ –ø–æ–¥ –∏–º–µ–Ω–µ–º –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–æ —Å–ª–µ–¥—É—é—â–µ–π ‚úÖ</div>
  </main>

  <script>
    const grid = document.getElementById('grid');
    const stats = document.getElementById('stats');
    const leader = document.getElementById('leader');
    const q = document.getElementById('q');

    // –§–∞–π–ª –ª–µ–∂–∏—Ç –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ —Ä—è–¥–æ–º —Å index.html
    const CSV_URL = 'progress.csv';

    let ALL = [];

    window.addEventListener('DOMContentLoaded', () => {
      loadCSV();
      q.addEventListener('input', renderFiltered);
    });

    async function loadCSV(){
      try{
        // –í–ê–ñ–ù–û: –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç—å index.html –∫–∞–∫ file://, –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç.
        if (location.protocol === 'file:'){
          stats.textContent = '–û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ GitHub Pages';
          leader.innerHTML = '';
          const warn = document.createElement('div');
          warn.className = 'leaderCard';
          const left = document.createElement('div');
          left.innerHTML = '<div class="leaderTitle">‚ö†Ô∏è –õ–æ–∫–∞–ª—å–Ω–æ</div><div class="leaderName">Fetch –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–∑ file://</div><div class="leaderMeta">–û—Ç–∫—Ä–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ GitHub Pages –∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä, VS Code Live Server).</div>';
          warn.appendChild(left);
          leader.appendChild(warn);
          return;
        }

        const res = await fetch(CSV_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error('CSV not found');
        const text = await res.text();
        const rows = parseCSV(text);
        ALL = rowsToStudents(rows);
        renderFiltered();
      } catch(e){
        stats.textContent = 'CSV –Ω–µ –Ω–∞–π–¥–µ–Ω';
        grid.innerHTML = '';
        leader.innerHTML = '';
        const msg = document.createElement('div');
        msg.className = 'leaderCard';
        msg.innerHTML = '<div><div class="leaderTitle">–ù–µ –≤–∏–∂—É progress.csv</div><div class="leaderMeta">–ü—Ä–æ–≤–µ—Ä—å: —Ñ–∞–π–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ç–æ–π –∂–µ –ø–∞–ø–∫–µ, —á—Ç–æ –∏ index.html, –∏ –Ω–∞–∑—ã–≤–∞—Ç—å—Å—è —Ç–æ—á–Ω–æ progress.csv</div></div>';
        leader.appendChild(msg);
      }
    }

    function renderFiltered(){
      const term = (q.value || '').trim().toLowerCase();
      const list = term ? ALL.filter(s => s.name.toLowerCase().includes(term)) : ALL;
      stats.textContent = '–£—á–µ–Ω–∏–∫–æ–≤: ' + list.length;
      renderLeader(ALL);
      renderList(list);
    }

    function renderLeader(students){
      leader.innerHTML = '';
      if (!students.length) return;

      const best = [...students].sort((a,b) => (b.tasks - a.tasks) || a.name.localeCompare(b.name, 'ru'))[0];
      const checks = checksCount(best.tasks);
      const toNext = best.tasks % 5 === 0 ? 5 : (5 - (best.tasks % 5));
      const pct = progressPercent(best.tasks);

      const box = document.createElement('div');
      box.className = 'leaderCard';

      const info = document.createElement('div');
      const t1 = document.createElement('div');
      t1.className = 'leaderTitle';
      t1.textContent = 'üèÜ –õ–∏–¥–µ—Ä';

      const nm = document.createElement('div');
      nm.className = 'leaderName';
      nm.textContent = best.name;

      const meta = document.createElement('div');
      meta.className = 'leaderMeta';
      meta.textContent = best.tasks + ' –∑–∞–¥–∞–Ω–∏–π ‚Ä¢ ‚úÖ √ó ' + checks + ' ‚Ä¢ –¥–æ —Å–ª–µ–¥—É—é—â–µ–π ‚úÖ: ' + toNext;

      const bar = document.createElement('div');
      bar.className = 'bar';
      const fill = document.createElement('i');
      fill.style.width = pct + '%';
      bar.appendChild(fill);

      info.appendChild(t1);
      info.appendChild(nm);
      info.appendChild(meta);
      info.appendChild(bar);

      const checksBox = document.createElement('div');
      checksBox.style.fontWeight = '950';
      const shown = Math.min(checks, 12);
      checksBox.textContent = (shown > 0 ? '‚úÖ'.repeat(shown) : '');
      if (checks > 12) checksBox.textContent += '‚Ä¶';

      box.appendChild(info);
      box.appendChild(checksBox);
      leader.appendChild(box);
    }

    function renderList(students){
      grid.innerHTML = '';
      if (!students.length){
        const empty = document.createElement('div');
        empty.className = 'pill';
        empty.textContent = '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.';
        grid.appendChild(empty);
        return;
      }
      const frag = document.createDocumentFragment();
      for (const s of students) frag.appendChild(createCard(s));
      grid.appendChild(frag);
    }

    // CSV –±–µ–∑ —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —Å—é—Ä–ø—Ä–∏–∑–æ–≤
    function parseCSV(text){
      const t = text.split('\r\n').join('\n').split('\r').join('\n');
      const lines = t.split('\n').map(x => x.trim()).filter(Boolean);
      if (!lines.length) return [];

      const delimiter = (lines[0].includes(';') && !lines[0].includes(',')) ? ';' : ',';
      return lines.map(line => splitCSVLine(line, delimiter));
    }

    function splitCSVLine(line, delimiter){
      const out = [];
      let cur = '';
      let inQuotes = false;
      for (let i=0; i<line.length; i++){
        const ch = line[i];
        if (ch === '"'){
          // –¥–≤–æ–π–Ω–∞—è –∫–∞–≤—ã—á–∫–∞ –≤–Ω—É—Ç—Ä–∏ –∫–∞–≤—ã—á–µ–∫
          if (inQuotes && i + 1 < line.length && line[i+1] === '"'){
            cur += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (ch === delimiter && !inQuotes){
          out.push(cur.trim());
          cur = '';
        } else {
          cur += ch;
        }
      }
      out.push(cur.trim());
      return out;
    }

    function rowsToStudents(rows){
      if (!rows.length) return [];
      const header = rows[0].map(x => (x || '').trim().toLowerCase());
      const iName = header.indexOf('—Ñ–∏–æ');
      const iTasks = header.indexOf('–∑–∞–¥–∞–Ω–∏—è');
      const iAvatar = header.indexOf('–∞–≤–∞—Ç–∞—Ä–∫–∞');
      const hasHeader = iName !== -1 && iTasks !== -1;

      const start = hasHeader ? 1 : 0;
      const students = [];

      for (let r=start; r<rows.length; r++){
        const row = rows[r];
        const name = hasHeader ? row[iName] : row[0];
        const tasksRaw = hasHeader ? row[iTasks] : row[1];
        const avatar = hasHeader ? (row[iAvatar] || '') : (row[2] || '');
        if (!name) continue;
        students.push({
          name: String(name).trim(),
          tasks: toInt(tasksRaw),
          avatar: String(avatar || '').trim()
        });
      }

      students.sort((a,b) => (b.tasks - a.tasks) || a.name.localeCompare(b.name, 'ru'));
      return students;
    }

    function toInt(v){
      const s = String(v == null ? '' : v);
      let num = '';
      for (let i=0; i<s.length; i++){
        const ch = s[i];
        if ((ch >= '0' && ch <= '9') || (ch === '-' && num.length === 0)) num += ch;
      }
      const n = parseInt(num || '0', 10);
      return Number.isFinite(n) ? Math.max(0, n) : 0;
    }

    function checksCount(tasks){
      return Math.floor(tasks / 5);
    }

    function progressPercent(tasks){
      const mod = tasks % 5;
      if (tasks > 0 && mod === 0) return 100;
      return Math.round((mod / 5) * 100);
    }

    function createCard(s){
      const card = document.createElement('article');
      card.className = 'card';

      const left = document.createElement('div');
      left.className = 'left';

      const avatarBox = document.createElement('div');
      avatarBox.className = 'avatar';

      const fallback = document.createElement('div');
      fallback.className = 'fallback';
      fallback.textContent = 'üéì';

      if (s.avatar){
        const img = document.createElement('img');
        img.alt = '–ê–≤–∞—Ç–∞—Ä: ' + s.name;
        img.loading = 'lazy';
        img.src = s.avatar;
        img.addEventListener('error', () => {
          avatarBox.innerHTML = '';
          avatarBox.appendChild(fallback);
        });
        avatarBox.appendChild(img);
      } else {
        avatarBox.appendChild(fallback);
      }

      left.appendChild(avatarBox);

      const mid = document.createElement('div');
      mid.className = 'mid';

      const name = document.createElement('div');
      name.className = 'name';
      name.textContent = s.name;

      const meta = document.createElement('div');
      meta.className = 'meta';

      const row = document.createElement('div');
      row.className = 'row';

      const tasksText = document.createElement('span');
      tasksText.textContent = s.tasks + ' –∑–∞–¥–∞–Ω–∏–π';

      const badge = document.createElement('span');
      badge.className = 'badge';
      badge.textContent = '‚úÖ √ó ' + checksCount(s.tasks);

      row.appendChild(tasksText);
      row.appendChild(badge);

      const bar = document.createElement('div');
      bar.className = 'bar';
      const fill = document.createElement('i');
      fill.style.width = progressPercent(s.tasks) + '%';
      bar.appendChild(fill);

      meta.appendChild(row);
      meta.appendChild(bar);

      mid.appendChild(name);
      mid.appendChild(meta);

      const right = document.createElement('div');
      right.className = 'right';

      const count = checksCount(s.tasks);
      if (count === 0){
        const tiny = document.createElement('span');
        tiny.className = 'empty';
        tiny.textContent = '–ø–æ–∫–∞ –±–µ–∑ ‚úÖ';
        right.appendChild(tiny);
      } else {
        const shown = Math.min(count, 12);
        for (let i=0; i<shown; i++){
          const c = document.createElement('span');
          c.className = 'check';
          c.textContent = '‚úÖ';
          right.appendChild(c);
        }
        if (count > 12){
          const dots = document.createElement('span');
          dots.className = 'empty';
          dots.textContent = '‚Ä¶';
          right.appendChild(dots);
        }
      }

      card.appendChild(left);
      card.appendChild(mid);
      card.appendChild(right);

      return card;
    }
  </script>
</body>
</html>
